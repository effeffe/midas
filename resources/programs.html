<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="mhttpd.css">
    <script src="mhttpd.js"></script>
    <title>Programs</title>
  </head>

  <body>

    <script>
    url = mhttpd_getParameterByName("URL");
    if (url)
       mjsonrpc_set_url(url);
    mhttpd_navigation_bar("Programs");
    </script>
    
    <div id="start_stop_overlay">
      <div>
        <p>text1</p>
        <p>text2</p>
        <p>text3</p>
        <p>text4</p>
        <input type=button value="Close overlay" onClick='clearTimeout(start_stop_timer_id); mhttpd_hide_overlay(start_stop_overlay); page_update();'></input>
      </div>
    </div>

    <div>
      <table class="subStatusTable" id="stripeList">
        <tr><td colspan=5 class="subStatusTitle">Programs</td></tr>
        <tr class="titleRow"><th>Program<th>Running on host<th>Alarm class<th>Autorestart<th>Commands</tr>
      </table>
    </div>
   
    <div id="updateStatus" align="left">
      updateStatus
    </div>

    <script>
    mhttpd_page_footer();
    </script>

    <script>
    var update_timer_id;
    var start_stop_overlay;
    var start_stop_modal;
    var start_stop_timer_id;
    
    function start_stop_poll(msg, name, start_command, count)
    {
       //msg.style.textAlign = "left";
       if (start_command) {
          msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to start.";
          msg.children[1].innerHTML = "Start command: " + start_command;
       } else {
          msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to stop.";
          msg.children[1].innerHTML = "";
       }
       mjsonrpc_cm_exist(name, false).then(function(rpc) {
          var done = false;
          if (start_command)
             done = (rpc.result.status == 1);
          else
             done = (rpc.result.status != 1);
          msg.children[2].innerHTML = "cm_exist() status: " + rpc.result.status + " done: " + done;
          msg.children[3].innerHTML = "Will try again: " + count;
          if (done) {
             //mhttpd_hide_overlay(start_stop_overlay);
             //update();
             if (start_command)
                msg.children[3].innerHTML = "Program started";
             else
                msg.children[3].innerHTML = "Program stopped";
          } else {
             if (count > 0) {
                start_stop_timer_id = setTimeout(function() { start_stop_poll(msg, name, start_command, count-1); }, 1000);
             } else {
                if (start_command)
                   msg.children[3].innerHTML = "Timeout. Program cannot be started by MIDAS. Try to start it in a terminal, run: " + start_command;
                else
                   msg.children[3].innerHTML = "Timeout. Program cannot be stopped by MIDAS. Try to kill it with \"kill -KILL\"";
             }
          }
       }).catch(function(error) {
          mjsonrpc_error_alert(error);
          mhttpd_hide_overlay(start_stop_overlay);
       });
    }
    
    function add_table_entry(table, name, full_name, start_command, colspan)
    {
       function new_attribute(name, value)
       {
          var att = document.createAttribute(name);
          if (value)
             att.value = value;
          return att;
       }
       
       var tr = document.createElement("tr");
       tr.setAttributeNode(new_attribute("id", "program " + name));
       var td;
       var input;
       
       td = document.createElement("td");
       td.setAttributeNode(new_attribute("id", "program name " + name));
       td.setAttributeNode(new_attribute("align", "center"));
       td.setAttributeNode(new_attribute("colspan", colspan));
       td.innerHTML = "<a href='Programs/" + full_name + "'>"+full_name+"</a>";
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.setAttributeNode(new_attribute("id", "program host " + name));
       td.setAttributeNode(new_attribute("align", "center"));
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.setAttributeNode(new_attribute("id", "program alarm " + name));
       td.setAttributeNode(new_attribute("align", "center"));
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.setAttributeNode(new_attribute("id", "program autorestart " + name));
       td.setAttributeNode(new_attribute("align", "center"));
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.setAttributeNode(new_attribute("id", "program control " + name));
       
       var start_button = document.createElement("button");
       input = start_button;
       input.id = "start " + name;
       input.type = "button";
       input.innerHTML = "Start " + full_name;
       mhttpd_disable_button(input);
       input.onclick = function() {
          mhttpd_disable_button(start_button);
          mhttpd_unhide_overlay(start_stop_overlay);
          //alert('Start!');
          mjsonrpc_start_program(name).then(function(rpc) {
             start_stop_poll(start_stop_modal, name, start_command, 10);
          }).catch(function(error) {
             mjsonrpc_error_alert(error);
             mhttpd_hide_overlay(start_stop_overlay);
          });
       };
       
       td.appendChild(input);
       
       // need spacer beteen the buttons
       //td.appendChild("x&nbspx");
       
       var stop_button = document.createElement("button");
       input = stop_button;
       input.id = "stop " + name;
       input.type = "button";
       input.innerHTML = "Stop " + full_name;
       mhttpd_disable_button(input);
       input.onclick = function() {
          mhttpd_disable_button(stop_button);
          mhttpd_unhide_overlay(start_stop_overlay);
          //alert('Stop!');
          mjsonrpc_stop_program(name, false).then(function(rpc) {
             start_stop_poll(start_stop_modal, name, null, 10);
          }).catch(function(error) {
             mjsonrpc_error_alert(error);
             mhttpd_hide_overlay(start_stop_overlay);
          });
       };
       
       td.appendChild(input);
       
       tr.appendChild(td);
       
       table.appendChild(tr);
       
       return tr;
    }
    
    function callback(rpc)
    {
       document.getElementById('updateStatus').innerHTML = "Requesting...Waiting...Processing...";
       
       function set_text(dom_prefix, item, value)
       {
          var e = document.getElementById(dom_prefix + item);
          if (e) e.innerHTML = value;
       }
       
       function set_color(dom_prefix, item, value)
       {
          var e = document.getElementById(dom_prefix + item);
          if (e) e.style.backgroundColor = value;
       }
       
       function set_class(dom_prefix, item, value)
       {
          var e = document.getElementById(dom_prefix + item);
          if (e) e.className = value;
       }
       
       function find_client(clients, name)
       {
          var found;
          var name_lc = name.toLowerCase(name);
          for (var key in clients) {
             var cname = clients[key].name;
             if (!cname) {
                continue;
             }
             var cname_lc =  cname.toLowerCase();
             var same_name = (cname_lc == name_lc);
             var matching_name = false;
             
             if (!same_name) {
                var n = cname_lc.search(name_lc);
                if (n==0) {
                   matching_name = true;
                   // FIXME: check that remaining text is all numbers: for "odbedit", match "odbedit111", but not "odbeditxxx"
                }
             }
             
             if (same_name || matching_name) {
                if (!found)
                   found = new Array();
                found.push(key);
             }
          }
          return found;
       }
       
       //alert("Hello: " + JSON.stringify(r));
       
       var programs = rpc.result.data[0];
       var clients  = rpc.result.data[1];
       var alarms   = rpc.result.data[2];
       
       for (var name in programs) {
          if (typeof programs[name] !== 'object') continue;
          var full_name = programs[name + "/name"];
          var e = document.getElementById("program " + name);
          var required = programs[name].required;
          var xclients = find_client(clients, name);
          //alert("name " + name + " clients: " + JSON.stringify(xclients));
          if (required || xclients) {
             var start_command = programs[name]["start command"];
             
             if (!e) {
                e = add_table_entry(document.getElementById("stripeList"), name, full_name, start_command, 1);
             }
             
             e.style.display = '';
             
             if (xclients) {
                var s = "";
                for (var i=0; i<xclients.length; i++) {
                   var key = xclients[i];
                   var host = clients[key].host;
                   if (host) {
                      if (s.length > 0)
                         s += "<br>";
                      s += "<a href='/System/Clients/"+key+"'>"+host+"</a>";
                   }
                }
                set_text("program host ", name, s);
                set_class("program host ", name, "greenLight");
                // enable start/stop buttons
                var e = document.getElementById("start " + name);
                if (e) {
                   mhttpd_disable_button(e);
                   mhttpd_hide_button(e);
                }
                var e = document.getElementById("stop " + name);
                if (e) {
                   mhttpd_enable_button(e);
                   mhttpd_unhide_button(e);
                }
             } else {
                set_text("program host ", name, "Not running");
                set_class("program host ", name, "redLight");
                // enable start/stop buttons
                var e = document.getElementById("start " + name);
                if (e && start_command) {
                   mhttpd_enable_button(e);
                   mhttpd_unhide_button(e);
                }
                var e = document.getElementById("stop " + name);
                if (e) {
                   mhttpd_disable_button(e);
                   mhttpd_hide_button(e);
                }
             }
             
             var alarm_class = programs[name]["alarm class"];
             if (alarm_class.length > 0) {
                set_text("program alarm ", name, "<a href='Alarms/Classes/"+ alarm_class + "'>" + alarm_class + "</a>");
                set_class("program alarm ", name, "yellowLight");
             } else {
                set_text("program alarm ", name, "-");
             }
             
             if (programs[name]["auto restart"])
                set_text("program autorestart ", name, "Yes");
             else
                set_text("program autorestart ", name, "No");
          } else {
             if (e) {
                e.style.display = 'none';
             }
          }
       }
       
       document.getElementById('mhttpd_last_updated').innerHTML = new Date;
       document.getElementById('updateStatus').innerHTML = "Requesting...Waiting...Processing...Done.";
    }
    
    function update()
    {
       var paths = [ "/Programs", "/System/Clients", "/Alarms" ];
       document.getElementById('updateStatus').innerHTML = "Requesting...";
       mjsonrpc_db_get_values(paths).then(function(rpc) {
          callback(rpc);
       }).catch(function(error) {
          document.getElementById('updateStatus').innerHTML = "Requesting...Waiting...RPC error.";
       });
       document.getElementById('updateStatus').innerHTML = "Requesting...Waiting...";
    }
    
    function update_periodic()
    {
       clearTimeout(update_timer_id);
       var update_period = 1000;
       update();
       update_timer_id = setTimeout('update_periodic()', update_period);
    }

    start_stop_overlay = document.getElementById("start_stop_overlay");
    start_stop_modal = mhttpd_init_overlay(start_stop_overlay);
    //mhttpd_unhide_overlay(start_stop_overlay);
    update_periodic();
    </script>
  </body>
</html>
