<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="mhttpd.css">
    <script src="mhttpd.js"></script>
    <title>Programs</title>
  </head>

  <body>

    <script>
    url = mhttpd_getParameterByName("URL");
    if (url)
       mjsonrpc_set_url(url);
    mhttpd_navigation_bar("Programs");
    </script>
    
    <div id="start_box" style="display:none">
      <div id="start_msg">
        <p>text1</p>
        <p>text2</p>
        <p>text3</p>
        <p>text4</p>
        <input type=button value="Close box" onClick='clearTimeout(start_timer_id); this.parentNode.parentNode.style.display="none"; update();'></input>
      </div>
    </div>

    <div id="stop_box" style="display:none">
      <div id="stop_msg">
        <p>text1</p>
        <p>text2</p>
        <p>text3</p>
        <p>text4</p>
        <input type=button value="Close box" onClick='clearTimeout(stop_timer_id); this.parentNode.parentNode.style.display="none"; update();'></input>
      </div>
    </div>

    <div id="start_stop_overlay">
      <div>
        <p>text1</p>
        <p>text2</p>
        <p>text3</p>
        <p>text4</p>
        <input type=button value="Close overlay" onClick='clearTimeout(start_stop_timer_id); mhttpd_hide_overlay(start_stop_overlay); update();'></input>
      </div>
    </div>

    <div>
      <table class="subStatusTable" id="stripeList">
        <tr><td colspan=5 class="subStatusTitle">Programs</td></tr>
        <tr class="titleRow"><th>Program<th>Running on host<th>Alarm class<th>Autorestart<th>Commands</tr>
      </table>
    </div>
   
    <div id="updateStatus" align="left">
      updateStatus
    </div>

    <script>
    mhttpd_page_footer();
    </script>

    <script>
    var update_timer_id;

    var start_stop_overlay;
    var start_stop_modal;
    var start_stop_timer_id;
    var start_timer_id;
    var stop_timer_id;
    
    function start_poll(box, msg, name, start_command, count)
    {
       msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to start.";
       msg.children[1].innerHTML = "Start command: " + start_command;

       mjsonrpc_cm_exist(name, false).then(function(rpc) {
          var done = (rpc.result.status == 1);
          msg.children[2].innerHTML = "cm_exist() status: " + rpc.result.status + " done: " + done;
          msg.children[3].innerHTML = "Will try again: " + count;
          if (done) {
             msg.children[3].innerHTML = "Program started";
             setTimeout(function() { box.style.display = "none"; }, 1000);
             update();
          } else if (count > 0) {
             start_timer_id = setTimeout(function() { start_poll(box, msg, name, start_command, count-1); }, 1000);
          } else {
             msg.children[3].innerHTML = "Timeout. Program cannot be started by MIDAS. Try to start it in a terminal, run: " + start_command;
          }
       }).catch(function(error) {
          mjsonrpc_error_alert(error);
       });
    }
    
    function stop_poll(box, msg, name, count)
    {
       msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to stop.";
       msg.children[1].innerHTML = "";

       mjsonrpc_cm_exist(name, false).then(function(rpc) {
          var done = (rpc.result.status != 1);
          msg.children[2].innerHTML = "cm_exist() status: " + rpc.result.status + " done: " + done;
          msg.children[3].innerHTML = "Will try again: " + count;
          if (done) {
             msg.children[3].innerHTML = "Program stopped";
             setTimeout(function() { box.style.display = "none"; }, 1000);
             update();
          } else if (count > 0) {
             stop_timer_id = setTimeout(function() { stop_poll(box, msg, name, count-1); }, 1000);
          } else {
             msg.children[3].innerHTML = "Timeout. Program cannot be stopped by MIDAS. Try to kill it with \"kill -KILL\"";
          }
       }).catch(function(error) {
          mjsonrpc_error_alert(error);
       });
    }
    
    function start_stop_poll(msg, name, start_command, count)
    {
       //msg.style.textAlign = "left";
       if (start_command) {
          msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to start.";
          msg.children[1].innerHTML = "Start command: " + start_command;
       } else {
          msg.children[0].innerHTML = "Waiting for program \"" + name + "\" to stop.";
          msg.children[1].innerHTML = "";
       }
       mjsonrpc_cm_exist(name, false).then(function(rpc) {
          var done = false;
          if (start_command)
             done = (rpc.result.status == 1);
          else
             done = (rpc.result.status != 1);
          msg.children[2].innerHTML = "cm_exist() status: " + rpc.result.status + " done: " + done;
          msg.children[3].innerHTML = "Will try again: " + count;
          if (done) {
             //mhttpd_hide_overlay(start_stop_overlay);
             //update();
             if (start_command)
                msg.children[3].innerHTML = "Program started";
             else
                msg.children[3].innerHTML = "Program stopped";
          } else {
             if (count > 0) {
                start_stop_timer_id = setTimeout(function() { start_stop_poll(msg, name, start_command, count-1); }, 1000);
             } else {
                if (start_command)
                   msg.children[3].innerHTML = "Timeout. Program cannot be started by MIDAS. Try to start it in a terminal, run: " + start_command;
                else
                   msg.children[3].innerHTML = "Timeout. Program cannot be stopped by MIDAS. Try to kill it with \"kill -KILL\"";
             }
          }
       }).catch(function(error) {
          mjsonrpc_error_alert(error);
          mhttpd_hide_overlay(start_stop_overlay);
       });
    }
    
    function add_table_entry(table, name, full_name, start_command)
    {
       var tr = document.createElement("tr");
       tr.id = "program " + name;

       var td;
       var input;
       
       td = document.createElement("td");
       td.align = "center";
       td.innerHTML = "<a href='Programs/" + full_name + "'>"+full_name+"</a>";
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.align = "center";
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.align = "center";
       tr.appendChild(td);
       
       td = document.createElement("td");
       td.align = "center";
       tr.appendChild(td);
       
       td = document.createElement("td");
       
       var start_button = document.createElement("button");
       input = start_button;
       input.id = "start " + name;
       input.type = "button";
       input.innerHTML = "Start " + full_name;
       mhttpd_disable_button(input);
       input.onclick = function() {
          var start_box = document.getElementById("start_box");
          var start_msg = document.getElementById("start_msg");
          mhttpd_disable_button(start_button);
          start_box.style.display = "";
          mjsonrpc_start_program(name).then(function(rpc) {
             //start_stop_poll(start_modal, name, start_command, 10);
             start_poll(start_box, start_msg, name, start_command, 10);
          }).catch(function(error) {
             mjsonrpc_error_alert(error);
          });
       };
       
       td.appendChild(input);
       
       // need spacer beteen the buttons
       //td.appendChild("x&nbspx");
       
       var stop_button = document.createElement("button");
       input = stop_button;
       input.id = "stop " + name;
       input.type = "button";
       input.innerHTML = "Stop " + full_name;
       mhttpd_disable_button(input);
       input.onclick = function() {
          var stop_box = document.getElementById("stop_box");
          var stop_msg = document.getElementById("stop_msg");
          mhttpd_disable_button(stop_button);
          stop_box.style.display = "";
          mjsonrpc_stop_program(name, false).then(function(rpc) {
             //start_stop_poll(start_stop_modal, name, null, 10);
             stop_poll(stop_box, stop_msg, name, 10);
          }).catch(function(error) {
             mjsonrpc_error_alert(error);
          });
       };
       
       td.appendChild(input);
       
       tr.appendChild(td);
       
       table.appendChild(tr);
       
       return tr;
    }
    
    function callback(rpc)
    {
       document.getElementById('updateStatus').innerHTML = "RWP_";
       
       function find_clients(clients, name)
       {
          var found;
          var name_lc = name.toLowerCase(name);
          for (var key in clients) {
             var cname = clients[key].name;
             if (!cname) {
                continue;
             }
             var cname_lc =  cname.toLowerCase();
             var same_name = (cname_lc == name_lc);
             var matching_name = false;
             
             if (!same_name) {
                var n = cname_lc.search(name_lc);
                if (n==0) {
                   matching_name = true;
                   // FIXME: check that remaining text is all numbers: for "odbedit", match "odbedit111", but not "odbeditxxx"
                }
             }
             
             if (same_name || matching_name) {
                if (!found)
                   found = new Array();
                found.push(key);
             }
          }
          return found;
       }
       
       //alert("Hello: " + JSON.stringify(r));
       
       var programs = rpc.result.data[0];
       var clients  = rpc.result.data[1];
       var alarms   = rpc.result.data[2];
       
       for (var name in programs) {
          if (typeof programs[name] !== 'object') continue;

          var e = document.getElementById("program " + name);

          var required = programs[name].required;
          var xclients = find_clients(clients, name);

          //alert("name " + name + " clients: " + JSON.stringify(xclients));

          if (!xclients && !required) {
             if (e) {
                // hide this table row
                e.style.display = 'none';
             }
             continue;
          }

          var start_command = programs[name]["start command"];

          if (!e) {
             var full_name = programs[name + "/name"];
             e = add_table_entry(document.getElementById("stripeList"), name, full_name, start_command);
          }

          // unhide this table row
          e.style.display = '';
          
          if (xclients) {
             var s = "";
             for (var i=0; i<xclients.length; i++) {
                var key = xclients[i];
                var host = clients[key].host;
                if (host) {
                   if (s.length > 0)
                      s += "<br>";
                   s += "<a href='/System/Clients/"+key+"'>"+host+"</a>";
                }
             }
             e.childNodes[1].innerHTML = s;
             e.childNodes[1].className = "greenLight";
             // enable start/stop buttons
             var b = document.getElementById("start " + name);
             if (b) {
                mhttpd_disable_button(b);
                mhttpd_hide_button(b);
             }
             var b = document.getElementById("stop " + name);
             if (b) {
                mhttpd_enable_button(b);
                mhttpd_unhide_button(b);
             }
          } else {
             e.childNodes[1].innerHTML = "Not running";
             e.childNodes[1].className = "redLight";
             // enable start/stop buttons
             var b = document.getElementById("start " + name);
             if (b && start_command) {
                mhttpd_enable_button(b);
                mhttpd_unhide_button(b);
             }
             var b = document.getElementById("stop " + name);
             if (b) {
                mhttpd_disable_button(b);
                mhttpd_hide_button(b);
             }
          }
             
          var alarm_class = programs[name]["alarm class"];
          if (alarm_class.length > 0) {
             e.childNodes[2].innerHTML = "<a href='Alarms/Classes/"+ alarm_class + "'>" + alarm_class + "</a>";
             e.childNodes[2].className = "yellowLight";
          } else {
             e.childNodes[2].innerHTML = "-";
          }
          
          if (programs[name]["auto restart"])
             e.childNodes[3].innerHTML = "Yes";
          else
             e.childNodes[3].innerHTML = "No";
       }
       
       document.getElementById('mhttpd_last_updated').innerHTML = new Date;
       document.getElementById('updateStatus').innerHTML = "RWPD";
    }
    
    function update()
    {
       var paths = [ "/Programs", "/System/Clients", "/Alarms" ];
       document.getElementById('updateStatus').innerHTML = "R___";
       mjsonrpc_db_get_values(paths).then(function(rpc) {
          callback(rpc);
       }).catch(function(error) {
          document.getElementById('updateStatus').innerHTML = "RWE: RPC or JS error.";
       });
       document.getElementById('updateStatus').innerHTML = "RW__";
    }
    
    function update_periodic()
    {
       clearTimeout(update_timer_id);
       var update_period = 1000;
       update();
       update_timer_id = setTimeout('update_periodic()', update_period);
    }

    start_stop_overlay = document.getElementById("start_stop_overlay");
    start_stop_modal = mhttpd_init_overlay(start_stop_overlay);
    //mhttpd_unhide_overlay(start_stop_overlay);
    update_periodic();
    </script>
  </body>
</html>
