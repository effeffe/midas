<!DOCTYPE html>
<html class="mcss">
<head>
   <link rel="stylesheet" href="midas.css">
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <title>Elog message</title>
</head>

<body class="mcss" onload="mhttpd_init('Elog')">
<div id="mheader"></div>
<div id="msidenav"></div>

<div id="mmain">
  <div>
    <table class="mtable">
      <tbody id="elog_table">
        <tr>
          <td colspan="6 "class="mtableheader" id="table_name">Elog Query Results</td>
        </tr>
        <tr>
          <td colspan="6" align="center">
            <form method="GET">
              <div id="buttons_block">
                <input class="mbutton" type=submit name=cmd value="New elog">
                <input class="mbutton" type=submit name=cmd value="Query elog">
                <input class="mbutton" type=submit name=cmd value="Last elog">
              </div>
            </form>
          </td>
        </tr>
        
        <tr id="query_runs_block">
          <td colspan=6>
          <b>Query result between runs <span id="r1">(r1)</span> and <span id="r2">(r2)</span></b>
          </td>
        </tr>
        <tr id="query_runs_today_block">
          <td colspan=6>
          <b>Query result between run <span id="xr1">(r1)</span> and today</b>
          </td>
        </tr>
        <tr hidden id="query_last_n_hours">
          <td colspan=6>
            Query: Last <span id="last_n_hours">(last_n_hours)</span> hours
          </td>
        </tr>
        <tr hidden id="query_last_n_days">
          <td colspan=6>
            Query: Last <span id="last_n_days">(last_n_days)</span> days
          </td>
        </tr>
        <tr>
          <td colspan=6>
            <b>Query result between (m1) (d1) (y1) and (m2) (d2) (y2)</b>
          </td>
        </tr>
        <tr>
          <td colspan=6>
            <b>Query result between (m1) (d1) (y1) and now</b>
          </td>
        </tr>
        
        <tr>
          <td colspan="6">
            Query:
            Author: <b>(author)</b>
            Type: <b>(type)</b>
            System: <b>(system)</b>
            Subject: <b>(subject)</b>
            Text: <b>(subtext)</b>
          </td>
        </tr>
        
        <tr>
          <th>Date</th>
          <th>Run</th>
          <th>Author</th>
          <th>Type</th>
          <th>System</th>
          <th>Subject</th>
        </tr>
      </tbody>
    </table>
    
    <script type="text/javascript">
    
    function set_text(id, text) {
       var e = document.getElementById(id);
       if (e) {
          e.innerHTML = text;
       }
    }
    
    function set_value(id, text) {
       var e = document.getElementById(id);
       if (e) {
          e.value = text;
       }
    }
    
    function set_checked(id, checked) {
       var e = document.getElementById(id);
       if (e) {
          e.checked = checked;
       }
    }
    
    function add_option(id, text, selected) {
       var e = document.getElementById(id);
       //console.log("add_option: [" + id + "] " + e + " text[" + text + "] selected " + selected);
       if (e) {
          var o = document.createElement("option");
          o.value = text;
          o.innerHTML = text;
          o.selected = selected;
          e.appendChild(o);
       }
    }
    
    function add_button(id, text) {
       var e = document.getElementById(id);
       //console.log("add_option: [" + id + "] " + e + " text[" + text + "] selected " + selected);
       if (e) {
          var o = document.createElement("input");
          o.type = "submit";
          o.name = "cmd";
          o.value = text;
          o.className = "mbutton";
          e.appendChild(o);
       }
    }
    
    function hide(id) {
       var e = document.getElementById(id);
       if (e) {
          e.style.visibility = "hidden";
          e.style.display = "none";
       }
    }
    
    function unhide(id) {
       var e = document.getElementById(id);
       if (e) {
          e.style.visibility = "";
          e.style.display = "";
          e.hidden = 0;
       }
    }
    
    function disable(id) {
       var e = document.getElementById(id);
       if (e) {
          e.disabled = true;
       }
    }
    
    function set_att_link(id, text) {
       var e = document.getElementById(id);
       if (e) {
          e.innerHTML = text;
          //e.download  = text;
          e.href = text + "?cmd=elog_att";
       }
    }

    function add_attachment(e, text) {
       var tr = document.createElement("tr");
       var td;
       
       td = document.createElement("td");
       td.colSpan = 6;
       td.innerHTML = "Attachment: <a href=\"" + text + "?cmd=elog_att\">" + text + "</a>";
       tr.appendChild(td);

       e.appendChild(tr);
    }

    
    function load() {
       var cmd = mhttpd_getParameterByName("cmd");
       //set_text("table_name", "Elog message " + tag);

       var y1 = mhttpd_getParameterByName("y1");
       var m1 = mhttpd_getParameterByName("m1");
       var d1 = mhttpd_getParameterByName("d1");
       var r1 = mhttpd_getParameterByName("r1");
       
       var y2 = mhttpd_getParameterByName("y2");
       var m2 = mhttpd_getParameterByName("m2");
       var d2 = mhttpd_getParameterByName("d2");
       var r2 = mhttpd_getParameterByName("r2");

       var last_n_hours = 0;

       if (cmd.toLowerCase().startsWith("elog last")) {
          var last = cmd.substring(10);
          last_n_hours = parseInt(last);

          if (last.endsWith("h")) {
             set_text("last_n_hours", last_n_hours);
             unhide("query_last_n_hours");
             last_n_hours *= 1;
          } else if (last.endsWith("d")) {
             set_text("last_n_days", last_n_hours);
             unhide("query_last_n_days");
             last_n_hours *= 24;
          }
          
          console.log("cmd: " + cmd + ", last: [" + last + "], last_n_hours: " + last_n_hours);
       }

       set_text("r1", r1);
       set_text("r2", r2);

       set_text("xr1", r1);
       
	    var req = new Object();

	    req.y1 = y1;
	    req.m1 = m1;
	    req.d1 = d1;
	    req.r1 = r1;

	    req.y2 = y2;
	    req.m2 = m2;
	    req.d2 = d2;
	    req.r2 = r2;

       req.last_n_hours = last_n_hours;

       var show_text = false;

       mjsonrpc_call("el_query", req).then(function (rpc) {
          var status = rpc.result.status;
          var msg_array = rpc.result.msg;

          console.log("el_query returned messages: " + msg_array.length);

          var e = document.getElementById("elog_table");
          
          for (var i=0; i<msg_array.length; i++) {
             var msg = msg_array[i];
          
             console.log("el_query message " + i + " tag " + msg.tag + " run " + msg.run);
             
             var encoding = msg.encoding;
             
             var html = false;
             if (encoding == "HTML")
                html = true;
             
             //console.log("msg encoding: " + encoding);

             // <a href=%s>%s</a><td>%d<td>%s<td>%s<td>%s<td>%s</tr> ref, date, run, author, type, system, subject
             var tr = document.createElement("tr");
             var td;
             
             td = document.createElement("td");

             td.innerHTML = "<a href=\"?cmd=Show+Elog&tag=" + msg.tag + "\">" + msg.date + "</a>";
             tr.appendChild(td);

             td = document.createElement("td");
             td.innerHTML = msg.run;
             tr.appendChild(td);

             td = document.createElement("td");
             td.innerHTML = msg.author;
             tr.appendChild(td);

             td = document.createElement("td");
             td.innerHTML = msg.type;
             tr.appendChild(td);

             td = document.createElement("td");
             td.innerHTML = msg.system;
             tr.appendChild(td);

             td = document.createElement("td");
             td.innerHTML = msg.subject;
             tr.appendChild(td);

             e.appendChild(tr);

             tr = document.createElement("tr");

             td = document.createElement("td");
             tr.appendChild(td);

             if (show_text) {
                td = document.createElement("td");
                td.colSpan = 5;
                if (html) {
                   td.innerHTML = msg.text;
                } else {
                   td.innerHTML = "<pre>" + msg.text + "</pre>";
                }
                tr.appendChild(td);
             }

             e.appendChild(tr);

             if (msg.attachment0.length > 0) {
                add_attachment(e, msg.attachment0);
             }
             
             if (msg.attachment1.length > 0) {
                add_attachment(e, msg.attachment1);
             }
             
             if (msg.attachment2.length > 0) {
                add_attachment(e, msg.attachment2);
             }
          }

          var odb_list = [
             "/Elog",
          ];
          
          mjsonrpc_db_get_values(odb_list).then(function (rpc) {
             var elog = rpc.result.data[0];
             
             //if (!elog["display run number"]) {
             //   hide("run_number");
             //}

             //if (!elog["allow delete"]) {
             //   disable("elog_delete_button");
             //}

             //if (!elog["allow edit"]) {
             //   disable("elog_edit_button");
             //}

             if ("buttons" in elog) {
                for (var i=0; i<elog.buttons.length; i++) {
                   if (elog.buttons[i].length > 0) {
                      add_button("buttons_block", "Elog Last " + elog.buttons[i]);
                   }
                }
             }
             
          }).catch(function (error) {
             mjsonrpc_error_alert(error);
          });
       }).catch(function (error) {
          mjsonrpc_error_alert(error);
       });
    }
    
    </script>
  </div>
</div>

<script>
load();
</script>
</body>
</html>
