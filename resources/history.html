<!DOCTYPE html>
<html class="mcss" lang=en">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="midas.css">
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <script src="mhistory.js"></script>
   <script src="controls.js"></script>
   <title>History</title>
</head>

<body class="mcss" onload="mhttpd_init('JSHistory'); mhistory_init(); init();">

<!-- header and side navigation will be filled automatically in mhttpd_start -->
<div id="mheader"></div>
<div id="msidenav"></div>

<script>

   function getUrlVars() {
      let vars = {};
      window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
         vars[key] = value;
      });
      return vars;
   }

   function init() {

      mjsonrpc_db_copy(["/History/Display"]).then(function (rpc) {
         let historyDisplay = rpc.result.data[0];

         let curGroup = decodeURI(getUrlVars()["group"]);
         let curPanel = decodeURI(getUrlVars()["panel"]);
         let baseURL = window.location.href;
         if (baseURL.search("&group") > 0)
            baseURL = baseURL.substr(0, baseURL.search("&group"));

         if (curGroup === "undefined") {
            // create selector table
            let d = document.getElementById("hist");

            let h =
               "<table class=\"mtable\" id=\"overallTable\">\n" +
               "    <tr><th colspan=\"2\" class=\"mtableheader\">History</th></tr>\n" +
               "    <tr><td colspan=2><input type=\"button\" name=\"New\" value=\"New\" onClick=\"window.location.href='?cmd=history&hcmd=New'\"></td></tr>\n" +
               "    <tr><td colspan=2 style=\"text-align:center;\"><b>Please select panel:</b></td></tr>\n" +
               "    <tr><td colspan=2 class=\"titleCell\"><a href=\"?cmd=history&group=All\">ALL</a>\n</td></tr>\n";


            Object.keys(historyDisplay).forEach(group => {
               h +=
                  "    <tr>\n" +
                  "      <td class=\"titleCell\"><a href=\"" + baseURL + "&group=" + group + "&panel=All\">" + group + "</a></td>\n" +
                  "      <td>\n";

               Object.keys(historyDisplay[group]).forEach(panel => {
                  h += "         <a href=\"" + baseURL + "&group=" + group + "&panel=" + panel + "\">" + panel + "</a>&nbsp;\n";
               });

               h +=
                  "      </td>\n" +
                  "    </tr>\n";
            });

            h +=
               "</table>\n";

            d.innerHTML = h;
            return;
         }

         let d = document.getElementById("hist");

         d.innerHTML =
            "<table class=\"mtable\" id=\"overallTable\">\n" +
            "   <tr><th class=\"mtableheader\">History</th></tr>\n" +
            "   <tr><td>\n" +
            "      Group:\n" +
            "      <select title=\"Select Group\" id=\"sgroup\">\n" +
            "      </select>&nbsp;&nbsp;\n" +
            "      Panel:\n" +
            "      <select title=\"Select Panel\" id=\"spanel\">\n" +
            "      </select>\n" +
            "   </td></tr>\n" +
            "   <tr><td>\n" +
            "      <div id=\"histPanel\"></div>\n" +
            "   </td></tr>\n" +
            "</table>\n";

         if (curGroup === "undefined")
            curGroup = Object.keys(historyDisplay)[0];
         if (curPanel === "undefined")
            curPanel = Object.keys(historyDisplay[curGroup])[0];

         // create history object
         mhistory_create(document.getElementById("histPanel"), curGroup, curPanel);

         // populate group selector
         let sgroup = document.getElementById("sgroup");
         Object.keys(historyDisplay).forEach(key => {
            let o = document.createElement("option");
            o.text = key;
            sgroup.add(o);
            if (curGroup === key)
               o.selected = true;
         });
         let o = document.createElement("option");
         o.text = "- All -";
         o.value = "All";
         sgroup.add(o);
         if (curGroup === "All")
            o.selected = true;

         // populate panel selector
         let spanel = document.getElementById("spanel");
         Object.keys(historyDisplay[curGroup]).forEach(key => {
            let o = document.createElement("option");
            o.text = key;
            spanel.add(o);
            if (curPanel === key)
               o.selected = true;
         });
         o = document.createElement("option");
         o.text = "- All -";
         o.value = "All";
         spanel.add(o);
         if (curPanel === "All")
            o.selected = true;

         // add listener to group selector
         document.getElementById("sgroup").addEventListener("change", function () {
            window.location.href = baseURL + "&group=" + document.getElementById("sgroup").value;
         });

         // add listener to panel selector
         document.getElementById("spanel").addEventListener("change", function () {
            window.location.href = baseURL +
               "&group=" + document.getElementById("sgroup").value +
               "&panel=" + document.getElementById("spanel").value;
         });

         window.addEventListener("resize", windowResize);
         windowResize();


      }).catch(function (error) {
         mjsonrpc_error_alert(error);
      });
   }

   function windowResize() {
      let m = document.getElementById("mmain");
      let d = document.getElementById("histPanel").childNodes[0];
      d.style.width = document.documentElement.clientWidth - parseInt(m.style.marginLeft) - 30 + "px";
      d.style.height = document.documentElement.clientHeight - d.getBoundingClientRect().top - 20 + "px";
      d.mhg.resize();
   }

</script>

<div id="mmain">
   <div id="hist"></div>
</div>

</body>
</html>
