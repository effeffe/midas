<!DOCTYPE html>
<html class="mcss">
<!--Created by Shuoyi Ma in 27st July 2017-->

<head>
    <script></script>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="midas.css" type="text/css">
    <!-- not using old css file any more <link rel="stylesheet" href="mhttpd.css">-->
    <script src="midas.js"></script>
    <script src="mhttpd.js"></script>
    <title>MIDAS online database</title>
</head>

<body class="mcss" onload="mhttpd_init('ODB',1000,update_periodic)">

    <div id="mheader"></div>
    <div id="msidenav"></div>

    <div id="mmain">

        <table class="mmaintable" id="ODBTable">
            <tr><th colspan="7" class="mtableheader">Online Database Browser</th></tr>
            <tr id="actionBar">
            </tr>
            <tr id="currentDir">
            </tr>


        </table>


    </div>


    <script>
        var update_timer_id;

        var global_rpc_data = null;

        var global_dir_data = null;

        var currentEditing = null;

        const ODBTableinnerHTML = "<tr><th colspan=\"7\" class=\"mtableheader\">Online Database Browser</th></tr><tr id=\"actionBar\"></tr><tr id=\"currentDir\"></tr>";


        function callback(rpc, currentDir) {

            var ODBTable = document.getElementById("ODBTable");


            function generateSub_Dir() {
                if (sub_dir.length > 0) {
                    sub_dir.forEach(function (element) {
                        var sub_dir_row = document.createElement("tr");
                        var sub_dir_col = document.createElement("td");
                        var sub_dir_link = document.createElement("a");
                        sub_dir_link.href = global_dir_data + "/" + element;
                        sub_dir_link.innerHTML = "&#9654; " + element
                        sub_dir_col.appendChild(sub_dir_link);
                        sub_dir_row.appendChild(sub_dir_col);
                        ODBTable.appendChild(sub_dir_row);
                    });
                }
            }

            function generateODB_Keys() {

            }


            // odb directory very rarely changes
            if (global_dir_data != currentDir) {
                global_dir_data = currentDir;
                document.getElementById("currentDir").innerHTML = "";
                var currentDirLink = document.createElement("a");
                currentDirLink.href = currentDir;
                currentDirLink.innerText = currentDir;
                document.getElementById("currentDir").appendChild(currentDirLink);
            }


            // since odb data rarely changes while browsing, if any change dynamically happens, refresh the whole page

            if (JSON.stringify(global_rpc_data) != JSON.stringify(rpc.result.data)) {
                global_rpc_data = rpc.result.data;

                if (rpc.result.data != null && rpc.result.data != undefined) {

                    var obj = rpc.result.data[0];
                    var sub_dir = new Array();
                    var odb_keys = new Array();

                    //get all keys of the data object
                    var keys = Object.keys(rpc.result.data[0])

                    // for each key...
                    keys.forEach(function (key) {
                        // if the value of the key is not an object, then it must be a key with value
                        if (typeof obj[key] !== 'object') {
                            odb_keys.push(key);
                            // if the value of the key is an object and length is 0, then it must be a sub directory
                        } else if (Object.keys(obj[key]).length === 0) {
                            sub_dir.push(key);
                        }
                        // rest of them are key properties
                    });

                    generateSub_Dir();
                    generateODB_Keys();

                }
            }
        }


        function update() {
            //alert(global_base_url);
            var sub_directory = (window.location.host + window.location.pathname).replace(global_base_url, "");
            sub_directory = sub_directory.replace("%20", " ");
            //alert("/"+sub_directory);


            var paths = ["/Alarms"];
            mjsonrpc_db_ls(paths).then(function (rpc) {
                callback(rpc, paths[0]);
            });
        }


        function update_periodic() {
            clearTimeout(update_timer_id);
            var update_period = 1000;
            update();
            update_timer_id = setTimeout('update_periodic()', update_period);
        }
    </script>

</body>


</html>